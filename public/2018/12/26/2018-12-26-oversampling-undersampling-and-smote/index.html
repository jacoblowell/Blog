<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Oversampling, Undersampling and SMOTE &middot; My Name</title>
        <meta name="description" content="hmeq %&gt;% filter(!is.na(VALUE)) %&gt;%ggplot( aes(x = VALUE, y = LOAN , color= factor(BAD))) &#43;geom_point() &#43;scale_color_manual(values = c(&#39;dodgerblue&#39;, &#39;red&#39;)) &#43; facet_grid(~BAD) &#43; labs(title = &quot;Home Equity Loan Performance by loan amount and value of home&quot;) &#43;scale_y_continuous(labels = scales::dollar) &#43; scale_x_continuous(labels = scales::dollar)oversampling, unsersampling
These programs do not work well with missing values. They only are able to resample for complete cases.
*** level the dataset ***">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.53" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="Oversampling, Undersampling and SMOTE">
<meta property="og:description" content="hmeq %&gt;% filter(!is.na(VALUE)) %&gt;%ggplot( aes(x = VALUE, y = LOAN , color= factor(BAD))) &#43;geom_point() &#43;scale_color_manual(values = c(&#39;dodgerblue&#39;, &#39;red&#39;)) &#43; facet_grid(~BAD) &#43; labs(title = &quot;Home Equity Loan Performance by loan amount and value of home&quot;) &#43;scale_y_continuous(labels = scales::dollar) &#43; scale_x_continuous(labels = scales::dollar)oversampling, unsersampling
These programs do not work well with missing values. They only are able to resample for complete cases.
*** level the dataset ***">
<meta property="og:type" content="article">
<meta property="og:url" content="/2018/12/26/2018-12-26-oversampling-undersampling-and-smote/">
        <link rel="stylesheet" href="/dist/styles.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
    </head>
    <body>
        
<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'XXX', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="Jake learning toolbox" href="/">Jake learning toolbox</a>
                            </h1>
                        
                        <a class="button-square" href="/index.xml"><i class="fa fa-rss"></i></a>
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" title="Twitter" href="https://twitter.com/lowell_jacob">
                                <i class="fa fa-twitter"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/jacoblowell">
                                <i class="fa fa-github-alt"></i>
                            </a>
                        
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Email" title="Email" href="mailto:jakelowell@gmail.com">
                                <i class="fa fa-envelope"></i>
                            </a>
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Blog" href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a title="Projects" href="/project/">Projects</a>
    </li>

    <li class="site-nav-item">
        <a title="Contact" href="/page/contact/">Contact</a>
    </li>

    <li class="site-nav-item">
        <a title="About" href="/page/about/">About</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Oversampling, Undersampling and SMOTE</h1>
    
    <p class="post-date">
        <span>Published <time datetime="2018-12-26" itemprop="datePublished">Wed, Dec 26, 2018</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="https://google.com/&#43;XXX" itemprop="url" rel="author">Jacob Lowell</a>
            </span>
        </span>
    </p>
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    


<pre class="r"><code>hmeq %&gt;%  filter(!is.na(VALUE)) %&gt;%
  ggplot( aes(x = VALUE, y = LOAN , color= factor(BAD))) +
  geom_point() +
  scale_color_manual(values = c(&#39;dodgerblue&#39;, &#39;red&#39;)) + facet_grid(~BAD) + labs(title = &quot;Home Equity Loan Performance by loan amount and value of home&quot;)  +scale_y_continuous(labels = scales::dollar) + scale_x_continuous(labels = scales::dollar)</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-2-1.png" width="480" style="display: block; margin: auto;" /></p>
<p><strong>oversampling, unsersampling</strong></p>
<p>These programs do not work well with missing values. They only are able to resample for complete cases.</p>
<p>*** level the dataset ***</p>
<pre class="r"><code>library(ROSE)</code></pre>
<pre><code>## Loaded ROSE 0.0-3</code></pre>
<pre class="r"><code>#hmeq &lt;- na.omit(hmeq)
table(hmeq$BAD)</code></pre>
<pre><code>## 
##    0    1 
## 4771 1189</code></pre>
<pre class="r"><code>#hmeq &lt;- hmeq %&gt;% mutate(fill_notnull = 1)

hmeq$ID &lt;- seq.int(nrow(hmeq))

# for over and under, missing values skew

# Calculate the required number of cases in the over-sampled dataset
 n_new &lt;- 4771/(1-0.5)  # 4771 is the number of goods (non-bad)

# Over-sample
oversampling_result &lt;- ovun.sample(formula = BAD ~ ., data = hmeq,
                           method = &quot;over&quot;, N = n_new, seed = 2019)

# Verify the Class-balance of the over-sampled dataset
oversampled_hmeq &lt;- oversampling_result$data
prop.table(table(oversampled_hmeq$BAD))</code></pre>
<pre><code>## 
##         0         1 
## 0.3211067 0.6788933</code></pre>
<pre class="r"><code>oversampled_hmeq %&gt;%  ggplot(aes(x = ID , fill = as.factor(BAD) )) + geom_histogram(binwidth =  1) + facet_grid(~BAD)</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code>hmeq_bad_nona &lt;- hmeq %&gt;%  filter(BAD ==1 ) %&gt;%  drop_na()

unique_over_bad &lt;- oversampled_hmeq %&gt;% filter(BAD == 1)

unique_over_bad &lt;- unique_over_bad %&gt;%  group_by(ID) %&gt;%  slice(1) %&gt;% ungroup()

hmeq_good_nona &lt;- hmeq %&gt;%  filter(BAD ==0 ) %&gt;%  drop_na()

unique_over_good &lt;- oversampled_hmeq %&gt;% filter(BAD == 0)

unique_over_good &lt;- unique_over_good %&gt;%  group_by(ID) %&gt;%  slice(1) %&gt;% ungroup()</code></pre>
<p><strong><em>undersample</em></strong></p>
<pre class="r"><code>table(hmeq$BAD)</code></pre>
<pre><code>## 
##    0    1 
## 4771 1189</code></pre>
<pre class="r"><code> n_new &lt;- 1189/(0.5)  # 4771 is the number of bads (non-goods)

# Over-sample
undersampling_result &lt;- ovun.sample(formula = BAD ~ ., data = hmeq,
                           method = &quot;under&quot;, N = n_new, seed = 2019)

# Verify the Class-balance of the over-sampled dataset
undersampled_hmeq &lt;- undersampling_result$data
prop.table(table(undersampled_hmeq$BAD))</code></pre>
<pre><code>## 
##         0         1 
## 0.8738436 0.1261564</code></pre>
<div id="combine-over-and-under-sample" class="section level1">
<h1>combine over and under sample</h1>
<pre class="r"><code>table(hmeq$BAD)</code></pre>
<pre><code>## 
##    0    1 
## 4771 1189</code></pre>
<pre class="r"><code># Specify the desired number of cases in the balanced dataset and the fraction of fraud cases
n_new &lt;- 10000
bad_fraction &lt;- 0.5

# Combine ROS &amp; RUS!
sampling_result &lt;- ovun.sample(formula = BAD ~ ., data = hmeq,
                               method = &quot;both&quot;, N = n_new, p = bad_fraction, seed = 2018)

# Verify the Class-balance of the re-balanced dataset
sampled_hmeq &lt;- sampling_result$data
prop.table(table(sampled_hmeq$BAD))</code></pre>
<pre><code>## 
##      0      1 
## 0.5071 0.4929</code></pre>
<div id="test-dups-with-both-way-over-and-under-sample" class="section level2">
<h2>test dups with both way over and under sample</h2>
<pre class="r"><code>hmeq_bad_nona &lt;- hmeq %&gt;%  filter(BAD ==1 ) %&gt;%  drop_na()

unique_over_bad &lt;- sampled_hmeq %&gt;% filter(BAD == 1)

unique_over_bad &lt;- unique_over_bad %&gt;%  group_by(ID) %&gt;%  slice(1) %&gt;% ungroup()

hmeq_good_nona &lt;- hmeq %&gt;%  filter(BAD ==0 ) %&gt;%  drop_na()

unique_over_good &lt;- sampled_hmeq %&gt;% filter(BAD == 0)

unique_over_good &lt;- unique_over_good %&gt;%  group_by(ID) %&gt;%  slice(1) %&gt;% ungroup()





sampled_hmeq %&gt;%  ggplot(aes(x = ID , fill = as.factor(BAD) )) + geom_histogram(binwidth =  1) + facet_grid(~BAD) + labs(title = &quot;HMEQ BOTH OVER and UNDER&quot;  , caption = &quot;You can see that the underweight class is used a high number of times&quot;)</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
</div>
<div id="omit-nas" class="section level1">
<h1>omit nas</h1>
<div id="the-lgd-set-has-no-missing-values-so-oversampling-works-as-expected" class="section level3">
<h3>the lgd set has no missing values, so oversampling works as expected</h3>
<pre class="r"><code>#ll  &lt;- na.omit(lgd)
#hmeq &lt;- na.omit(hmeq)



#############################################################################
library(ROSE)

#hmeq &lt;- na.omit(hmeq)
table(lgd$event)</code></pre>
<pre><code>## 
##    0    1 
##  728 1817</code></pre>
<pre class="r"><code>#hmeq &lt;- hmeq %&gt;% mutate(fill_notnull = 1)

lgd$ID &lt;- seq.int(nrow(lgd))

# for over and under, missing values skew

# Calculate the required number of cases in the over-sampled dataset
 n_new &lt;- 1817/(1-0.5)  # 

# Over-sample
oversampling_result &lt;- ovun.sample(formula = event ~ ., data = lgd,
                           method = &quot;over&quot;, N = n_new, seed = 2019)

# Verify the Class-balance of the over-sampled dataset
oversampled_lgd &lt;- oversampling_result$data
prop.table(table(oversampled_lgd$event))</code></pre>
<pre><code>## 
##   0   1 
## 0.5 0.5</code></pre>
<pre class="r"><code>oversampled_lgd %&gt;%  ggplot(aes(x = ID , fill = as.factor(event) )) + geom_histogram(binwidth =  1) + facet_grid(~event) + labs(title = &quot;LGD oversample&quot;)</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-7-1.png" width="480" style="display: block; margin: auto;" /></p>
<pre class="r"><code>##############################################################################
table(lgd$event)</code></pre>
<pre><code>## 
##    0    1 
##  728 1817</code></pre>
<pre class="r"><code> n_new &lt;- 728/(0.5)  # 4771 is the number of bads (non-goods)

# Over-sample
undersampling_result &lt;- ovun.sample(formula = event ~ ., data = lgd,
                           method = &quot;under&quot;, N = n_new, seed = 2019)

# Verify the Class-balance of the over-sampled dataset
undersampled_lgd &lt;- undersampling_result$data
prop.table(table(undersampled_lgd$event))</code></pre>
<pre><code>## 
##   0   1 
## 0.5 0.5</code></pre>
<pre class="r"><code>undersampled_lgd %&gt;%  ggplot(aes(x = ID , fill = as.factor(event) )) + geom_histogram(binwidth =  1) + facet_grid(~event) + labs(title = &quot;LGD undersample&quot;)</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-8-1.png" width="480" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="smote" class="section level1">
<h1>smote</h1>
<pre class="r"><code>library(smotefamily)
library(FNN)
#hmeq2 &lt;- na.omit(hmeq)
#table(hmeq2$BAD)

table(lgd$event)</code></pre>
<pre><code>## 
##    0    1 
##  728 1817</code></pre>
<pre class="r"><code># Set the number of fraud and legitimate cases, and the desired percentage of legitimate cases
n0 &lt;- 727; n1 &lt;- 1817; r0 &lt;- 0.5

# Calculate the value for the dup_size parameter of SMOTE
ntimes &lt;- ((1 - r0) / r0) * (n0 / n1) - 1

# Create synthetic fraud cases with SMOTE
smote_output &lt;- SMOTE(X = lgd , target = lgd$event, K = 3, dup_size = 1.2)

# Make a scatter plot of the original and over-sampled dataset
lgd_smote &lt;- smote_output$data
colnames(lgd_smote)[10] &lt;- &quot;Class&quot;
#prop.table(table(lgd_smote$Class))

ggplot(lgd, aes(x = LTV, y = lgd_time, color = as.factor(event))) +
  geom_point() +
  scale_color_manual(values = c(&#39;dodgerblue2&#39;, &#39;red&#39;))</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<pre class="r"><code>ggplot(lgd_smote, aes(x = LTV, y = lgd_time, color = Class)) +
  geom_point() +
  scale_color_manual(values = c(&#39;dodgerblue2&#39;, &#39;red&#39;))</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-9-2.png" width="672" /></p>
<pre class="r"><code>ggplot(lgd, aes(x = LTV, y = lgd_time, color = as.factor(event))) +
  geom_point() +
  scale_color_manual(values = c(&#39;dodgerblue2&#39;, &#39;red&#39;)) + facet_wrap(~event , scales = &quot;free&quot;)</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<pre class="r"><code>ggplot(lgd_smote, aes(x = LTV, y = lgd_time, color = Class)) +
  geom_point() +
  scale_color_manual(values = c(&#39;dodgerblue2&#39;, &#39;red&#39;))</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-10-2.png" width="672" /></p>
<div id="section" class="section level7">
<p></p>
</div>
</div>
<div id="smote-with-missing-values-dataset-hmeq" class="section level1">
<h1>smote with missing values dataset hmeq</h1>
</div>
<div id="no-smote-does-not-like-nas" class="section level1">
<h1>no, smote does not like NA’s</h1>
</div>
<div id="smote-1" class="section level1">
<h1>smote</h1>
<pre class="r"><code>library(smotefamily)
library(FNN)
#hmeq2 &lt;- na.omit(hmeq)
#table(hmeq2$BAD)

hmeq &lt;- na.omit(hmeq)

table(hmeq$BAD)</code></pre>
<pre><code>## 
##    0    1 
## 3064  300</code></pre>
<pre class="r"><code># Set the number of fraud and legitimate cases, and the desired percentage of legitimate cases
n0 &lt;- 4771; n1 &lt;- 1189; r0 &lt;- 0.5

# Calculate the value for the dup_size parameter of SMOTE
ntimes &lt;- ((1 - r0) / r0) * (n0 / n1) - 1

# Create synthetic fraud cases with SMOTE
smote_output &lt;- SMOTE(X = hmeq[ , -c(1, 5, 6)] , target = hmeq$BAD, K = 3, dup_size = ntimes)

# Make a scatter plot of the original and over-sampled dataset
hmeq_smote &lt;- smote_output$data
colnames(hmeq_smote)[12] &lt;- &quot;Class&quot;
#prop.table(table(hmeq_smote$Class))

ggplot(hmeq, aes(x = MORTDUE, y = LOAN, color = as.factor(BAD))) +
  geom_point() +
  scale_color_manual(values = c(&#39;dodgerblue2&#39;, &#39;red&#39;))</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<pre class="r"><code>ggplot(hmeq_smote, aes(x = MORTDUE, y = LOAN, color = Class)) +
  geom_point() +
  scale_color_manual(values = c(&#39;dodgerblue2&#39;, &#39;red&#39;))</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-11-2.png" width="672" /></p>
<pre class="r"><code>ggplot(hmeq, aes(x = MORTDUE, y = LOAN, color = as.factor(BAD))) +
  geom_point() +
  scale_color_manual(values = c(&#39;dodgerblue2&#39;, &#39;red&#39;)) + facet_wrap(~BAD , scales = &quot;free&quot;)</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<pre class="r"><code>ggplot(hmeq_smote, aes(x = MORTDUE, y = LOAN, color = Class)) +
  geom_point() +
  scale_color_manual(values = c(&#39;dodgerblue2&#39;, &#39;red&#39;))  + facet_wrap(~Class , scales = &quot;free&quot;)</code></pre>
<p><img src="/post/2018-12-26-oversampling-undersampling-and-smote_files/figure-html/unnamed-chunk-12-2.png" width="672" /></p>
<div id="model" class="section level4">
<h4>model</h4>
<ol style="list-style-type: decimal">
<li>split into training and test 2.perform smote on one training set</li>
<li>train model on smote and non smote</li>
<li>compare performance</li>
</ol>
<pre class="r"><code># Train the rpart algorithm on the original training set and the SMOTE-rebalanced training set
#model_orig &lt;- rpart(event ~ ., data = train_original)
#model_smote &lt;- rpart(Class ~ ., data = train_oversampled)

# Predict the fraud probabilities of the test cases
#scores_orig &lt;- predict(model_orig, newdata = test, type = &quot;prob&quot;)[, 2]
#scores_smote &lt;- predict(model_smote, newdata = test, type = &quot;prob&quot;)[, 2]

# Convert the probabilities to classes (0 or 1) using a cutoff value
#predicted_class_orig &lt;- factor(ifelse(scores_orig &gt; 0.5, 1, 0))
#predicted_class_smote &lt;- factor(ifelse(scores_smote &gt; 0.5, 1, 0))

# Determine the confusion matrices and the model&#39;s accuracy
# CM_orig &lt;- confusionMatrix(data = predicted_class_orig, reference = test$Class)
# CM_smote &lt;- confusionMatrix(data = predicted_class_smote, reference = test$Class)
# print(CM_orig$table)
# print(CM_orig$overall[1])
# print(CM_smote$table)
# print(CM_smote$overall[1])</code></pre>
</div>
</div>

</div>

        <footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
            
                <a href="/tags/course-imbalance/">Course Imbalance</a>
            
        </p>
    

    <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?text=Oversampling%2c%20Undersampling%20and%20SMOTE&url=%2f2018%2f12%2f26%2f2018-12-26-oversampling-undersampling-and-smote%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
            </a>
        

        
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=%2f2018%2f12%2f26%2f2018-12-26-oversampling-undersampling-and-smote%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fa fa-facebook"></i>
                <span class="hidden">Facebook</span>
            </a>
        

        
            <a class="icon-google-plus" href="https://plus.google.com/share?url=%2f2018%2f12%2f26%2f2018-12-26-oversampling-undersampling-and-smote%2f"
              onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
              <i class="fa fa-google-plus"></i>
                <span class="hidden">Google+</span>
            </a>
        
        
    </div>
</footer>

        
    <div class="comments">
        
    </div>

    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Jake learning toolbox" href="/">Jake learning toolbox</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2019 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="/js/jquery-1.11.3.min.js"></script>
        <script src="/js/jquery.fitvids.js"></script>
        
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        
        <script src="/js/scripts.js"></script>
    </body>
</html>

